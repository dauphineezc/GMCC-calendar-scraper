<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Schedule</title>
  <meta name="color-scheme" content="light only" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --row-h: 64px; } /* 1 hour = 64px */
    html,body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .scrollbar::-webkit-scrollbar{ width:8px; height:8px; }
    .scrollbar::-webkit-scrollbar-track{ background:#f1f1f1;}
    .scrollbar::-webkit-scrollbar-thumb{ background:#a8a8a8; border-radius:4px;}
    .scrollbar::-webkit-scrollbar-thumb:hover{ background:#888; }
    .tab-btn.active{ border-bottom-color:#3b82f6; color:#111827; font-weight:600; }
    .day-col { position: relative; }
    .event-card { position:absolute; box-sizing:border-box; border-left-width:4px; border-radius:0.5rem; padding:0.5rem 0.75rem; z-index:10; }
    .now-line { position:absolute; height:2px; background:#ef4444; z-index:30; }
    .now-dot { position:absolute; width:8px; height:8px; background:#ef4444; border-radius:9999px; left:0; top:50%; transform:translate(-50%,-50%); }
    .tz-hide { display:none !important; }
    @media print {
      .no-print { display:none !important; }
      .print-block { display:block !important; }
      .event-card { box-shadow:none !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <main class="mx-auto max-w-7xl p-4">
    <!-- Controls -->
    <div class="no-print grid grid-cols-3 items-center gap-3 mb-3">
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100">◀</button>
        <button id="todayBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100">Today</button>
        <button id="nextBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100">▶</button>
      </div>
      <div id="rangeLabel" class="font-semibold text-center"></div>
      <div class="text-sm text-gray-500 tz-hide">Times shown in <span id="tzLabel"></span></div>
    </div>

    <!-- Tabs -->
    <div class="mb-4 border-b border-gray-200">
      <nav id="tabs" class="-mb-px flex flex-wrap gap-6"></nav>
    </div>

    <!-- Desktop grid -->
    <section class="hidden md:block bg-white rounded-lg shadow overflow-hidden">
      <div id="gridScroller" class="scrollbar overflow-auto" style="height: 80vh;">
        <div class="relative">
          <div id="gridHeader" class="grid sticky top-0 bg-white z-20 shadow-sm"
               style="grid-template-columns: 4rem repeat(7, minmax(120px, 1fr));"></div>
          <div id="gridBody" class="grid relative"
               style="grid-template-columns: 4rem repeat(7, minmax(120px, 1fr));"></div>
        </div>
      </div>
    </section>

    <!-- Mobile list -->
    <section id="listView" class="md:hidden bg-white rounded-lg shadow p-4 space-y-5 overflow-y-auto" style="height: 80vh;"></section>
  </main>

  <script>
    const PALETTE = {
      blue: ["bg-blue-100","text-blue-800","border-blue-500"],
      green: ["bg-green-100","text-green-800","border-green-500"],
      purple: ["bg-purple-100","text-purple-800","border-purple-500"],
      yellow: ["bg-yellow-100","text-yellow-800","border-yellow-500"],
      indigo: ["bg-indigo-100","text-indigo-800","border-indigo-500"],
      orange: ["bg-orange-100","text-orange-800","border-orange-500"],
      red: ["bg-red-100","text-red-800","border-red-500"],
      teal: ["bg-teal-100","text-teal-800","border-teal-500"],
      gray: ["bg-gray-200","text-gray-800","border-gray-500"],
      pink: ["bg-pink-100","text-pink-800","border-pink-500"],
      cyan: ["bg-cyan-100","text-cyan-800","border-cyan-500"]
    };

    const els = {
      tabs: document.getElementById("tabs"),
      gridHeader: document.getElementById("gridHeader"),
      gridBody: document.getElementById("gridBody"),
      list: document.getElementById("listView"),
      rangeLabel: document.getElementById("rangeLabel"),
      tzLabel: document.getElementById("tzLabel"),
      prevBtn: document.getElementById("prevBtn"),
      nextBtn: document.getElementById("nextBtn"),
      todayBtn: document.getElementById("todayBtn"),
      scroller: document.getElementById("gridScroller")
    };

    let weekStart = getMonday(new Date());
    let CALS = {};
    let currentCal = null;
    let dayOverlays = [];
    els.tzLabel.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;

    els.prevBtn.onclick = () => { weekStart = addDays(weekStart, -7); render(); };
    els.nextBtn.onclick = () => { weekStart = addDays(weekStart, +7); render(); };
    els.todayBtn.onclick = () => { weekStart = getMonday(new Date()); render(); };

    function getMonday(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); return addDays(x, -day); }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function ymd(d){ return d.toISOString().slice(0,10); }
    function labelDate(d){ return d.toLocaleDateString(undefined,{month:"short",day:"numeric"}); }

    async function loadWeekData() {
      const startISO = ymd(weekStart);
      const endISO = ymd(addDays(weekStart, 6));
      const res = await fetch(`/api/classes?start=${startISO}&end=${endISO}`);
      const data = await res.json();
      CALS = data;
      currentCal = Object.keys(CALS)[0] || null;
    }

    function renderTabs(){
      els.tabs.innerHTML = "";
      for (const key of Object.keys(CALS)){
        const btn = document.createElement("button");
        btn.className = "tab-btn py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500";
        btn.textContent = CALS[key].label;
        if (key === currentCal) btn.classList.add("active");
        btn.onclick = () => { currentCal = key; renderBody(); document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); };
        els.tabs.appendChild(btn);
      }
    }

    function renderHeader(){
      els.gridHeader.innerHTML = "";
      const timeCell = document.createElement("div");
      timeCell.className = "p-2 border-r border-b border-gray-200 text-xs text-center font-semibold text-gray-500 flex items-center justify-center";
      timeCell.textContent = "EDT";
      els.gridHeader.appendChild(timeCell);
      for (let i=0;i<7;i++){
        const d = addDays(weekStart,i);
        const h = document.createElement("div");
        h.className = "p-2 border-b border-gray-200 text-center";
        const isToday = ymd(d) === ymd(new Date());
        h.innerHTML = `<p class="text-xs font-medium ${isToday?"text-blue-600":"text-gray-500"}">${["MON","TUE","WED","THU","FRI","SAT","SUN"][i]}</p>
                       <p class="text-xs ${isToday?"font-semibold text-blue-600":""}">${labelDate(d)}</p>`;
        els.gridHeader.appendChild(h);
      }
      const end = addDays(weekStart,6);
      els.rangeLabel.textContent = `${labelDate(weekStart)} – ${labelDate(end)}`;
    }

    function renderBody(){ renderGrid(); renderList(); }

    function renderGrid(){
      const startHour = 5, endHour = 22;
      const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--row-h"));
      els.gridBody.innerHTML = "";
      dayOverlays = [];

      for (let hour=startHour; hour<=endHour; hour++){
        const t = document.createElement("div");
        t.className = "p-2 border-r border-gray-200 text-right text-xs text-gray-400 h-16 flex items-start justify-end -mt-2.5";
        if (hour < endHour){
          const h12 = (hour % 12)||12;
          t.textContent = `${h12} ${hour<12?"AM":"PM"}`;
        }
        els.gridBody.appendChild(t);
        for (let day=0; day<7; day++){
          const cell = document.createElement("div");
          cell.className = "border-r border-b border-gray-200 h-16 day-col";
          cell.dataset.day = day;
          els.gridBody.appendChild(cell);
        }
      }

      const firstRowCells = [...els.gridBody.querySelectorAll('.day-col')].slice(0,7);
      const totalHeight = (endHour - startHour) * rowH;
      for (let day=0; day<7; day++){
        const left = firstRowCells[day].offsetLeft + firstRowCells[day].clientLeft;
        const width = firstRowCells[day].clientWidth;
        const overlay = document.createElement('div');
        overlay.style.position = 'absolute';
        overlay.style.zIndex = '5';
        overlay.style.top = '0';
        overlay.style.left = `${left}px`;
        overlay.style.width = `${width}px`;
        overlay.style.height = `${totalHeight}px`;
        overlay.style.pointerEvents = 'none';
        els.gridBody.appendChild(overlay);
        dayOverlays[day] = overlay;
      }

      const events = CALS[currentCal]?.events || [];
      const groupsByDay = Array.from({length:7},()=>[]);
      events.forEach(e => groupsByDay[e.dayIndex].push(e));
      for (let day=0; day<7; day++){
        const dayEvents = groupsByDay[day].slice().sort((a,b)=> a.startMinutes-b.startMinutes);
        placeEventsInDay(day, dayEvents);
      }
    }

    function placeEventsInDay(dayIndex, dayEvents) {
      if (!dayEvents.length) return;
      const startHour = 5;
      const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--row-h"));
      const bucket = m => Math.floor(m / 5);
      const layout = {};
      dayEvents.forEach(ev => {
        for (let m = ev.startMinutes; m < ev.endMinutes; m += 5) {
          (layout[`${dayIndex}_${bucket(m)}`] ??= []).push(ev);
        }
      });
      dayEvents.forEach(ev => {
        const top = (ev.startMinutes - startHour*60) * (rowH / 60);
        const height = Math.max(8, (ev.endMinutes - ev.startMinutes) * (rowH / 60));
        const card = document.createElement(ev.url ? "a" : "div");
        if (ev.url) card.href = ev.url;
        card.className = `event-card shadow-sm ${ev.color.bg} ${ev.color.text} ${ev.color.border}`;
        card.style.top = `${top}px`;
        card.style.height = `${height}px`;
        card.style.pointerEvents = 'auto';
        const overlappers = layout[`${dayIndex}_${bucket(ev.startMinutes)}`] || [];
        const total = overlappers.length;
        const index = overlappers.indexOf(ev);
        if (total > 1) {
          const gap = 4;
          const eventWidthPct = 100 / total;
          card.style.width = `calc(${eventWidthPct}% - ${gap}px)`;
          card.style.left = `calc(${index * eventWidthPct}% + ${gap - (index * gap)}px)`;
        } else {
          const margin = 4;
          card.style.width = `calc(100% - ${margin * 2}px)`;
          card.style.left = `${margin}px`;
        }
        card.innerHTML = `<p class="font-semibold text-sm leading-tight">${ev.name}</p>
                          <p class="text-xs opacity-90">${formatRange(ev.startMinutes, ev.endMinutes)}</p>`;
        dayOverlays[dayIndex]?.appendChild(card);
      });
    }

    function renderList(){
      els.list.innerHTML = "";
      const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
      const byDay = Array.from({length:7},()=>[]);
      (CALS[currentCal]?.events || []).forEach(e => byDay[e.dayIndex].push(e));
      for (let i=0;i<7;i++){
        const d = addDays(weekStart,i);
        const header = document.createElement("div");
        const isToday = ymd(d) === ymd(new Date());
        header.className = "pt-2 pb-2 border-b";
        header.innerHTML = `<h2 class="text-lg font-bold ${isToday?"text-blue-700":""}">${days[i]}</h2>
                            <div class="text-xs text-gray-500">${labelDate(d)}</div>`;
        els.list.appendChild(header);
        if (!byDay[i].length){
          const none = document.createElement("div");
          none.className = "text-sm text-gray-400 pt-2"; none.textContent = "No events";
          els.list.appendChild(none);
        } else {
          byDay[i].sort((a,b)=>a.startMinutes-b.startMinutes).forEach(e=>{
            const item = document.createElement("div");
            item.className = `mt-2 p-3 rounded-lg ${e.color.bg} ${e.color.text}`;
            item.innerHTML = `<p class="font-semibold">${e.name}</p>
                              <p class="text-sm opacity-90">${formatRange(e.startMinutes, e.endMinutes)}</p>`;
            els.list.appendChild(item);
          });
        }
      }
    }

    function formatRange(startM, endM) {
      const fmt = m => {
        const h = Math.floor(m / 60), mins = m % 60;
        const h12 = (h % 12) || 12, ap = h < 12 ? "AM" : "PM";
        return `${h12}:${String(mins).padStart(2,'0')} ${ap}`;
      };
      return `${fmt(startM)} – ${fmt(endM)}`;
    }

    async function render(){
      await loadWeekData();
      renderTabs();
      renderHeader();
      renderBody();
    }

    render();
  </script>
</body>
</html>